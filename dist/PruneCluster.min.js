var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},PruneCluster;!function(a){function b(a,b){return a.lat>=b.minLat&&a.lat<=b.maxLat&&a.lng>=b.minLng&&a.lng<=b.maxLng}function c(a){for(var b,c,d,e=1,f=a.length;f>e;++e){for(c=a[e],d=c.position.lng,b=e-1;b>=0&&a[b].position.lng>d;--b)a[b+1]=a[b];a[b+1]=c}}var d=.2,e=function(){function a(){}return a}();a.Point=e;var f=function(){function a(){}return a}();a.ClusterObject=f;var g=function(a){function b(b,c,d){"undefined"==typeof d&&(d={}),a.call(this),this.data=d,this.position={lat:b,lng:c},this.weight=1}return __extends(b,a),b.prototype.Move=function(a,b){this.position.lat=a,this.position.lng=b},b}(f);a.Marker=g;var h=function(a){function b(b){a.call(this),this.lastMarker=b,this.stats={},this.data={},this.population=1,b.category&&(this.stats[b.category]=1),this.totalWeight=b.weight,this.position={lat:b.position.lat,lng:b.position.lng},this.averagePosition={lat:b.position.lat,lng:b.position.lng}}return __extends(b,a),b.prototype.AddMarker=function(a){this.lastMarker=a;var b=a.weight,c=this.totalWeight,d=b+c;this.averagePosition.lat=(this.averagePosition.lat*c+a.position.lat*b)/d,this.averagePosition.lng=(this.averagePosition.lng*c+a.position.lng*b)/d,++this.population,this.totalWeight=d,a.category&&(this.stats.hasOwnProperty(a.category)?++this.stats[a.category]:this.stats[a.category]=1)},b.prototype.Reset=function(){this.lastMarker=void 0,this.population=0,this.totalWeight=0},b.prototype.ComputeBounds=function(a){var b=a.Project(this.position.lat,this.position.lng),c=a.Size,d=Math.floor(b.x/c),e=Math.floor(b.y/c),f=d*c,g=e*c,h=a.UnProject(f,g),i=a.UnProject(f+c,g+c);this.bounds={minLat:i.lat,maxLat:h.lat,minLng:h.lng,maxLng:i.lng}},b}(f);a.Cluster=h;var i=function(){function a(){this._markers=[],this._nbChanges=0,this._clusters=[],this.Size=166,this.ViewPadding=.13}return a.prototype.RegisterMarker=function(a){a._removeFlag&&delete a._removeFlag,this._markers.push(a),this._nbChanges+=1},a.prototype._sortMarkers=function(){var a=this._markers,b=a.length;this._nbChanges&&(!b||this._nbChanges/b>d)?this._markers.sort(function(a,b){return a.position.lng-b.position.lng}):c(a),this._nbChanges=0},a.prototype._sortClusters=function(){c(this._clusters)},a.prototype._indexLowerBoundLng=function(a){for(var b,c,d=this._markers,e=0,f=d.length;f>0;)c=Math.floor(f/2),b=e+c,d[b].position.lng<a?(e=++b,f-=c+1):f=c;return e},a.prototype._resetClusterViews=function(){for(var a=0,b=this._clusters.length;b>a;++a){var c=this._clusters[a];c.Reset(),c.ComputeBounds(this)}},a.prototype.ProcessView=function(a){var c=Math.abs(a.maxLat-a.minLat)*this.ViewPadding,d=Math.abs(a.maxLng-a.minLng)*this.ViewPadding,e={minLat:a.minLat-c-c,maxLat:a.maxLat+c+c,minLng:a.minLng-d-d,maxLng:a.maxLng+d+d};this._sortMarkers(),this._resetClusterViews();for(var f=this._indexLowerBoundLng(e.minLng),g=this._markers,i=this._clusters,j=i.slice(0),k=f,l=g.length;l>k;++k){var m=g[k],n=m.position;if(n.lng>e.maxLng)break;if(n.lat>e.minLat&&n.lat<e.maxLat){for(var o,p=!1,q=0,r=j.length;r>q;++q)if(o=j[q],o.bounds.maxLng<m.position.lng)j.splice(q,1),--q,--r;else if(b(n,o.bounds)){o.AddMarker(m),p=!0;break}p||(o=new h(m),o.ComputeBounds(this),i.push(o),j.push(o))}}var s=[];for(k=0,l=i.length;l>k;++k)o=i[k],o.population>0&&s.push(o);return this._clusters=s,this._sortClusters(),this._clusters},a.prototype.RemoveMarkers=function(a){for(var b=0,c=a.length;c>b;++b)a[b]._removeFlag=!0;var d=[];for(b=0,c=this._markers.length;c>b;++b)this._markers[b]._removeFlag||d.push(this._markers[b]);this._markers=d},a.prototype.FindMarkersBoundsInArea=function(a){for(var b=a.minLat,c=a.maxLat,d=a.minLng,e=a.maxLng,f=Number.MAX_VALUE,g=Number.MIN_VALUE,h=Number.MAX_VALUE,i=Number.MIN_VALUE,j=this._markers,k=0,l=0,m=j.length;m>l;++l){var n=j[l].position;n.lat>=b&&n.lat<=c&&n.lng>=d&&n.lng<=e&&(++k,n.lat<f&&(f=n.lat),n.lat>g&&(g=n.lat),n.lng<h&&(h=n.lng),n.lng>i&&(i=n.lng))}return k?{minLat:f,maxLat:g,minLng:h,maxLng:i}:null},a}();a.PruneCluster=i}(PruneCluster||(PruneCluster={}));var PruneCluster;!function(){}(PruneCluster||(PruneCluster={}));var PruneClusterForLeaflet=L.Class.extend({initialize:function(a,b){var c=this;"undefined"==typeof a&&(a=160),"undefined"==typeof b&&(b=20),this.Cluster=new PruneCluster.PruneCluster,this.Cluster.Size=a,this.clusterMargin=Math.min(b,a/4),this.Cluster.Project=function(a,b){return c._map.project(new L.LatLng(a,b))},this.Cluster.UnProject=function(a,b){return c._map.unproject(new L.Point(a,b))},this._objectsOnMap=[]},RegisterMarker:function(a){this.Cluster.RegisterMarker(a)},RemoveMarkers:function(a){this.Cluster.RemoveMarkers(a)},BuildLeafletCluster:function(a,b){var c=this,d=new L.Marker(b,{icon:this.BuildLeafletClusterIcon(a)});return d.on("click",function(){var b=c.Cluster.FindMarkersBoundsInArea(a.bounds);b&&c._map.fitBounds(new L.LatLngBounds(new L.LatLng(b.minLat,b.maxLng),new L.LatLng(b.maxLat,b.minLng)))}),d},BuildLeafletClusterIcon:function(a){var b="prunecluster prunecluster-";return b+=a.population<10?"small":a.population<100?"medium":"large",new L.DivIcon({html:"<div><span>"+a.population+"</span></div>",className:b,iconSize:L.point(40,40)})},BuildLeafletMarker:function(a,b){return new L.Marker(b)},onAdd:function(a){this._map=a,a.on("dragend",this.ProcessView,this),a.on("zoomstart",this._zoomStart,this),a.on("zoomend",this._zoomEnd,this),this.ProcessView()},onRemove:function(a){a.off("dragend",this.ProcessView,this),a.off("zoomstart",this._zoomStart,this),a.off("zoomend",this._zoomEnd,this);for(var b=0,c=this._objectsOnMap.length;c>b;++b)this._map.removeLayer(this._objectsOnMap[b])},_zoomStart:function(){this.disableProcessView=!0},_zoomEnd:function(){this.disableProcessView=!1,this.ProcessView()},ProcessView:function(){var a=this;if(!this.disableProcessView){var b=this._map,c=b.getBounds(),d=b.getZoom(),e=this.clusterMargin/this.Cluster.Size,f=c.getSouthWest(),g=c.getNorthEast(),h=+new Date,i=this.Cluster.ProcessView({minLat:f.lat,minLng:f.lng,maxLat:g.lat,maxLng:g.lng});console.log("time: ",+new Date-h);for(var j=this._objectsOnMap,k=[],l=0,m=j.length;m>l;++l)j[l]._removeFromMap=!0;var n=[];i.forEach(function(c){var f=void 0,g=(c.bounds.maxLat-c.bounds.minLat)*e,h=(c.bounds.maxLng-c.bounds.minLng)*e,i=new L.LatLng(Math.max(Math.min(c.averagePosition.lat,c.bounds.maxLat-g),c.bounds.minLat+g),Math.max(Math.min(c.averagePosition.lng,c.bounds.maxLng-h),c.bounds.minLng+h)),j=c.data._leafletMarker;j&&(1===c.population&&1===c.data._leafletOldPopulation?(j.setLatLng(i),f=j):c.population>1&&c.data._leafletOldPopulation>1&&j._zoomLevel===d&&(j.setLatLng(i),j.setIcon(a.BuildLeafletClusterIcon(c)),c.data._leafletOldPopulation=c.population,f=j)),f||(f=1===c.population?a.BuildLeafletMarker(c.lastMarker,i):a.BuildLeafletCluster(c,i),f.addTo(b),f.setOpacity(0),n.push(f),c.data._leafletMarker=f,c.data._leafletOldPopulation=c.population),f._zoomLevel=d,f._removeFromMap=!1,k.push(f)}),window.setTimeout(function(){for(l=0,m=n.length;m>l;++l)n[l].setOpacity(1)},1);var o=[];for(l=0,m=j.length;m>l;++l)j[l]._removeFromMap&&(j[l].setOpacity(0),o.push(j[l]));o.length>0&&window.setTimeout(function(){for(l=0,m=o.length;m>l;++l)b.removeLayer(o[l])},300),this._objectsOnMap=k}}});
//# sourceMappingURL=PruneCluster.min.js.map