var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c},PruneCluster;!function(a){function b(a,b){return a.lat>=b.minLat&&a.lat<=b.maxLat&&a.lng>=b.minLng&&a.lng<=b.maxLng}function c(a){for(var b,c,d,e=1,f=a.length;f>e;++e){for(c=a[e],d=c.position.lng,b=e-1;b>=0&&a[b].position.lng>d;--b)a[b+1]=a[b];a[b+1]=c}}var d=.2,e=function(){function a(){}return a}();a.Point=e;var f=function(){function a(){}return a}();a.ClusterObject=f;var g=1,h=Math.pow(2,53)-1,i=function(a){function b(b,c,d,e,f,h){void 0===d&&(d={}),void 0===f&&(f=1),void 0===h&&(h=!1),a.call(this),this.data=d,this.position={lat:b,lng:c},this.weight=f,this.category=e,this.filtered=h,this.hashCode=g++}return __extends(b,a),b.prototype.Move=function(a,b){this.position.lat=a,this.position.lng=b},b.prototype.SetData=function(a){for(var b in a)this.data[b]=a[b]},b}(f);a.Marker=i;var j=function(a){function b(c){return a.call(this),this.stats=[0,0,0,0,0,0,0,0],this.data={},c?(b.ENABLE_MARKERS_LIST&&(this._clusterMarkers=[c]),this.lastMarker=c,this.hashCode=31+c.hashCode,this.population=1,void 0!==c.category&&(this.stats[c.category]=1),this.totalWeight=c.weight,this.position={lat:c.position.lat,lng:c.position.lng},void(this.averagePosition={lat:c.position.lat,lng:c.position.lng})):(this.hashCode=1,void(b.ENABLE_MARKERS_LIST&&(this._clusterMarkers=[])))}return __extends(b,a),b.prototype.AddMarker=function(a){b.ENABLE_MARKERS_LIST&&this._clusterMarkers.push(a);var c=this.hashCode;c=(c<<5)-c+a.hashCode,this.hashCode=c>=h?c%h:c,this.lastMarker=a;var d=a.weight,e=this.totalWeight,f=d+e;this.averagePosition.lat=(this.averagePosition.lat*e+a.position.lat*d)/f,this.averagePosition.lng=(this.averagePosition.lng*e+a.position.lng*d)/f,++this.population,this.totalWeight=f,void 0!==a.category&&(this.stats[a.category]=this.stats[a.category]+1||1)},b.prototype.Reset=function(){this.hashCode=1,this.lastMarker=void 0,this.population=0,this.totalWeight=0,this.stats=[0,0,0,0,0,0,0,0],b.ENABLE_MARKERS_LIST&&(this._clusterMarkers=[])},b.prototype.ComputeBounds=function(a){var b=a.Project(this.position.lat,this.position.lng),c=a.Size,d=Math.floor(b.x/c),e=Math.floor(b.y/c),f=d*c,g=e*c,h=a.UnProject(f,g),i=a.UnProject(f+c,g+c);this.bounds={minLat:i.lat,maxLat:h.lat,minLng:h.lng,maxLng:i.lng}},b.prototype.GetClusterMarkers=function(){return this._clusterMarkers},b.prototype.ApplyCluster=function(a){this.hashCode=41*this.hashCode+43*a.hashCode,this.hashCode>h&&(this.hashCode=this.hashCode=h);var c=a.totalWeight,d=this.totalWeight,e=c+d;this.averagePosition.lat=(this.averagePosition.lat*d+a.averagePosition.lat*c)/e,this.averagePosition.lng=(this.averagePosition.lng*d+a.averagePosition.lng*c)/e,this.population+=a.population,this.totalWeight=e,this.bounds.minLat=Math.min(this.bounds.minLat,a.bounds.minLat),this.bounds.minLng=Math.min(this.bounds.minLng,a.bounds.minLng),this.bounds.maxLat=Math.max(this.bounds.maxLat,a.bounds.maxLat),this.bounds.maxLng=Math.max(this.bounds.maxLng,a.bounds.maxLng);for(var f in a.stats)a.stats.hasOwnProperty(f)&&(this.stats.hasOwnProperty(f)?this.stats[f]+=a.stats[f]:this.stats[f]=a.stats[f]);b.ENABLE_MARKERS_LIST&&(this._clusterMarkers=this._clusterMarkers.concat(a.GetClusterMarkers()))},b.ENABLE_MARKERS_LIST=!1,b}(f);a.Cluster=j;var k=function(){function a(){this._markers=[],this._nbChanges=0,this._clusters=[],this.Size=166,this.ViewPadding=.2}return a.prototype.RegisterMarker=function(a){a._removeFlag&&delete a._removeFlag,this._markers.push(a),this._nbChanges+=1},a.prototype._sortMarkers=function(){var a=this._markers,b=a.length;this._nbChanges&&(!b||this._nbChanges/b>d)?this._markers.sort(function(a,b){return a.position.lng-b.position.lng}):c(a),this._nbChanges=0},a.prototype._sortClusters=function(){c(this._clusters)},a.prototype._indexLowerBoundLng=function(a){for(var b,c,d=this._markers,e=0,f=d.length;f>0;)c=Math.floor(f/2),b=e+c,d[b].position.lng<a?(e=++b,f-=c+1):f=c;return e},a.prototype._resetClusterViews=function(){for(var a=0,b=this._clusters.length;b>a;++a){var c=this._clusters[a];c.Reset(),c.ComputeBounds(this)}},a.prototype.ProcessView=function(a){var c=Math.abs(a.maxLat-a.minLat)*this.ViewPadding,d=Math.abs(a.maxLng-a.minLng)*this.ViewPadding,e={minLat:a.minLat-c-c,maxLat:a.maxLat+c+c,minLng:a.minLng-d-d,maxLng:a.maxLng+d+d};this._sortMarkers(),this._resetClusterViews();for(var f=this._indexLowerBoundLng(e.minLng),g=this._markers,h=this._clusters,i=h.slice(0),k=f,l=g.length;l>k;++k){var m=g[k],n=m.position;if(n.lng>e.maxLng)break;if(n.lat>e.minLat&&n.lat<e.maxLat&&!m.filtered){for(var o,p=!1,q=0,r=i.length;r>q;++q)if(o=i[q],o.bounds.maxLng<m.position.lng)i.splice(q,1),--q,--r;else if(b(n,o.bounds)){o.AddMarker(m),p=!0;break}p||(o=new j(m),o.ComputeBounds(this),h.push(o),i.push(o))}}var s=[];for(k=0,l=h.length;l>k;++k)o=h[k],o.population>0&&s.push(o);return this._clusters=s,this._sortClusters(),this._clusters},a.prototype.RemoveMarkers=function(a){if(!a)return void(this._markers=[]);for(var b=0,c=a.length;c>b;++b)a[b]._removeFlag=!0;var d=[];for(b=0,c=this._markers.length;c>b;++b)this._markers[b]._removeFlag||d.push(this._markers[b]);this._markers=d},a.prototype.FindMarkersInArea=function(a){for(var b=a.minLat,c=a.maxLat,d=a.minLng,e=a.maxLng,f=this._markers,g=[],h=this._indexLowerBoundLng(d),i=h,j=f.length;j>i;++i){var k=f[i].position;if(k.lng>e)break;k.lat>=b&&k.lat<=c&&k.lng>=d&&g.push(f[i])}return g},a.prototype.ComputeBounds=function(a){if(!a||!a.length)return null;for(var b=Number.MAX_VALUE,c=-Number.MAX_VALUE,d=Number.MAX_VALUE,e=-Number.MAX_VALUE,f=0,g=a.length;g>f;++f){var h=a[f].position;h.lat<b&&(b=h.lat),h.lat>c&&(c=h.lat),h.lng<d&&(d=h.lng),h.lng>e&&(e=h.lng)}return{minLat:b,maxLat:c,minLng:d,maxLng:e}},a.prototype.FindMarkersBoundsInArea=function(a){return this.ComputeBounds(this.FindMarkersInArea(a))},a.prototype.ComputeGlobalBounds=function(){return this.ComputeBounds(this._markers)},a.prototype.GetMarkers=function(){return this._markers},a.prototype.GetPopulation=function(){return this._markers.length},a.prototype.ResetClusters=function(){this._clusters=[]},a}();a.PruneCluster=k}(PruneCluster||(PruneCluster={}));var PruneCluster;!function(){}(PruneCluster||(PruneCluster={}));var PruneClusterForLeaflet=(L.Layer?L.Layer:L.Class).extend({initialize:function(a,b){var c=this;void 0===a&&(a=120),void 0===b&&(b=20),this.Cluster=new PruneCluster.PruneCluster,this.Cluster.Size=a,this.clusterMargin=Math.min(b,a/4),this.Cluster.Project=function(a,b){return c._map.project(new L.LatLng(a,b))},this.Cluster.UnProject=function(a,b){return c._map.unproject(new L.Point(a,b))},this._objectsOnMap=[],this.spiderfier=new PruneClusterLeafletSpiderfier(this),this._hardMove=!1,this._resetIcons=!1,this._removeTimeoutId=0,this._markersRemoveListTimeout=[]},RegisterMarker:function(a){this.Cluster.RegisterMarker(a)},RemoveMarkers:function(a){this.Cluster.RemoveMarkers(a)},BuildLeafletCluster:function(a,b){var c=this,d=new L.Marker(b,{icon:this.BuildLeafletClusterIcon(a)});return d.on("click",function(){var e=c.Cluster.FindMarkersInArea(a.bounds),f=c.Cluster.ComputeBounds(e);if(f){var g=new L.LatLngBounds(new L.LatLng(f.minLat,f.maxLng),new L.LatLng(f.maxLat,f.minLng)),h=c._map.getZoom(),i=c._map.getBoundsZoom(g,!1,new L.Point(20,20));i===h?(c._map.fire("overlappingmarkers",{cluster:c,markers:e,center:d.getLatLng(),marker:d}),c._map.setView(b,i)):c._map.fitBounds(g)}}),d},BuildLeafletClusterIcon:function(a){var b="prunecluster prunecluster-",c=38,d=this.Cluster.GetPopulation();return a.population<Math.max(10,.01*d)?b+="small":a.population<Math.max(100,.05*d)?(b+="medium",c=40):(b+="large",c=44),new L.DivIcon({html:"<div><span>"+a.population+"</span></div>",className:b,iconSize:L.point(c,c)})},BuildLeafletMarker:function(a,b){var c=new L.Marker(b);return this.PrepareLeafletMarker(c,a.data,a.category),c},PrepareLeafletMarker:function(a,b,c){if(b.icon&&a.setIcon("function"==typeof b.icon?b.icon(b,c):b.icon),b.popup){var d="function"==typeof b.popup?b.popup(b,c):b.popup;a.getPopup()?a.setPopupContent(d,b.popupOptions):a.bindPopup(d,b.popupOptions)}},onAdd:function(a){this._map=a,a.on("movestart",this._moveStart,this),a.on("moveend",this._moveEnd,this),a.on("zoomend",this._zoomStart,this),a.on("zoomend",this._zoomEnd,this),this.ProcessView(),a.addLayer(this.spiderfier)},onRemove:function(a){a.off("movestart",this._moveStart,this),a.off("moveend",this._moveEnd,this),a.off("zoomend",this._zoomStart,this),a.off("zoomend",this._zoomEnd,this);for(var b=0,c=this._objectsOnMap.length;c>b;++b)a.removeLayer(this._objectsOnMap[b].data._leafletMarker);this._objectsOnMap=[],this.Cluster.ResetClusters(),a.removeLayer(this.spiderfier),this._map=null},_moveStart:function(){this._moveInProgress=!0},_moveEnd:function(a){this._moveInProgress=!1,this._hardMove=a.hard,this.ProcessView()},_zoomStart:function(){this._zoomInProgress=!0},_zoomEnd:function(){this._zoomInProgress=!1,this.ProcessView()},ProcessView:function(){var a=this;if(this._map&&!this._zoomInProgress&&!this._moveInProgress){for(var b=this._map,c=b.getBounds(),d=b.getZoom(),e=this.clusterMargin/this.Cluster.Size,f=this._resetIcons,g=c.getSouthWest(),h=c.getNorthEast(),i=this.Cluster.ProcessView({minLat:g.lat,minLng:g.lng,maxLat:h.lat,maxLng:h.lng}),j=this._objectsOnMap,k=[],l=new Array(j.length),m=0,n=j.length;n>m;++m){var o=j[m].data._leafletMarker;l[m]=o,o._removeFromMap=!0}var p=[],q=[],r=[];for(m=0,n=i.length;n>m;++m){for(var s=i[m],t=s.data,u=(s.bounds.maxLat-s.bounds.minLat)*e,v=(s.bounds.maxLng-s.bounds.minLng)*e,w=0,x=r.length;x>w;++w){var y=r[w];if(y.bounds.maxLng<s.bounds.minLng)r.splice(w,1),--w,--x;else{var z=y.averagePosition.lng+v,A=y.averagePosition.lat-u,B=y.averagePosition.lat+u,C=s.averagePosition.lng-v,D=s.averagePosition.lat-u,E=s.averagePosition.lat+u;if(z>C&&B>D&&E>A){t._leafletCollision=!0,y.ApplyCluster(s);break}}}t._leafletCollision||r.push(s)}for(i.forEach(function(b){var c=void 0,e=b.data;if(e._leafletCollision)return e._leafletCollision=!1,e._leafletOldPopulation=0,void(e._leafletOldHashCode=0);var g=new L.LatLng(b.averagePosition.lat,b.averagePosition.lng),h=e._leafletMarker;h&&(1===b.population&&1===e._leafletOldPopulation&&b.hashCode===h._hashCode?((f||h._zoomLevel!==d||b.lastMarker.data.forceIconRedraw)&&(a.PrepareLeafletMarker(h,b.lastMarker.data,b.lastMarker.category),b.lastMarker.data.forceIconRedraw&&(b.lastMarker.data.forceIconRedraw=!1)),h.setLatLng(g),c=h):b.population>1&&e._leafletOldPopulation>1&&(h._zoomLevel===d||e._leafletPosition.equals(g))&&(h.setLatLng(g),(f||b.population!=e._leafletOldPopulation||b.hashCode!==e._leafletOldHashCode)&&h.setIcon(a.BuildLeafletClusterIcon(b)),e._leafletOldPopulation=b.population,e._leafletOldHashCode=b.hashCode,c=h)),c?(c._removeFromMap=!1,k.push(b),c._zoomLevel=d,c._hashCode=b.hashCode,c._population=b.population,e._leafletMarker=c,e._leafletPosition=g):(p.push(b),e._leafletPosition=g,e._leafletOldPopulation=b.population,e._leafletOldHashCode=b.hashCode)}),m=0,n=j.length;n>m;++m){s=j[m];var F=s.data;if(o=F._leafletMarker,F._leafletMarker._removeFromMap){var G=!0;if(o._zoomLevel===d){var H=s.averagePosition;for(u=(s.bounds.maxLat-s.bounds.minLat)*e,v=(s.bounds.maxLng-s.bounds.minLng)*e,w=0,x=p.length;x>w;++w){var I=p[w],J=I.data,K=I.averagePosition,M=H.lng-v,N=K.lng+v;if(z=H.lng+v,A=H.lat-u,B=H.lat+u,C=K.lng-v,D=K.lat-u,E=K.lat+u,z>C&&N>M&&B>D&&E>A&&(1===o._population&&1===I.population&&o._hashCode===I.hashCode?((f||I.lastMarker.data.forceIconRedraw)&&(this.PrepareLeafletMarker(o,I.lastMarker.data,I.lastMarker.category),I.lastMarker.data.forceIconRedraw&&(I.lastMarker.data.forceIconRedraw=!1)),o.setLatLng(J._leafletPosition),G=!1):o._population>1&&I.population>1&&(o.setLatLng(J._leafletPosition),o.setIcon(this.BuildLeafletClusterIcon(I)),J._leafletOldPopulation=I.population,J._leafletOldHashCode=I.hashCode,o._population=I.population,G=!1),!G)){J._leafletMarker=o,o._removeFromMap=!1,k.push(I),p.splice(w,1),--w,--x;break}}}G&&(o._removeFromMap||console.error("wtf"))}}for(m=0,n=p.length;n>m;++m){s=p[m],F=s.data;var O,P=F._leafletPosition;O=1===s.population?this.BuildLeafletMarker(s.lastMarker,P):this.BuildLeafletCluster(s,P),O.addTo(b),O.setOpacity(0),q.push(O),F._leafletMarker=O,O._zoomLevel=d,O._hashCode=s.hashCode,O._population=s.population,k.push(s)}if(window.setTimeout(function(){for(m=0,n=q.length;n>m;++m){var a=q[m];a._icon&&L.DomUtil.addClass(a._icon,"prunecluster-anim"),a._shadow&&L.DomUtil.addClass(a._shadow,"prunecluster-anim"),a.setOpacity(1)}},1),this._hardMove)for(m=0,n=l.length;n>m;++m)o=l[m],o._removeFromMap&&b.removeLayer(o);else{if(0!==this._removeTimeoutId)for(window.clearTimeout(this._removeTimeoutId),m=0,n=this._markersRemoveListTimeout.length;n>m;++m)b.removeLayer(this._markersRemoveListTimeout[m]);var Q=[];for(m=0,n=l.length;n>m;++m)o=l[m],o._removeFromMap&&(o.setOpacity(0),Q.push(o));Q.length>0&&(this._removeTimeoutId=window.setTimeout(function(){for(m=0,n=Q.length;n>m;++m)b.removeLayer(Q[m]);a._removeTimeoutId=0},300)),this._markersRemoveListTimeout=Q}this._objectsOnMap=k,this._hardMove=!1,this._resetIcons=!1}},FitBounds:function(){var a=this.Cluster.ComputeGlobalBounds();a&&this._map.fitBounds(new L.LatLngBounds(new L.LatLng(a.minLat,a.maxLng),new L.LatLng(a.maxLat,a.minLng)))},GetMarkers:function(){return this.Cluster.GetMarkers()},RedrawIcons:function(a){void 0===a&&(a=!0),this._resetIcons=!0,a&&this.ProcessView()}}),PruneClusterLeafletSpiderfier=(L.Layer?L.Layer:L.Class).extend({_2PI:2*Math.PI,_circleFootSeparation:25,_circleStartAngle:Math.PI/6,_spiralFootSeparation:28,_spiralLengthStart:11,_spiralLengthFactor:5,_spiralCountTrigger:8,spiderfyDistanceMultiplier:1,initialize:function(a){this._cluster=a,this._currentMarkers=[],this._multiLines=!!L.multiPolyline,this._lines=this._multiLines?L.multiPolyline([],{weight:1.5,color:"#222"}):L.polyline([],{weight:1.5,color:"#222"})},onAdd:function(a){this._map=a,this._map.on("overlappingmarkers",this.Spiderfy,this),this._map.on("click",this.Unspiderfy,this),this._map.on("zoomend",this.Unspiderfy,this)},Spiderfy:function(a){var b=this;if(a.cluster===this._cluster){this.Unspiderfy();var c=a.markers.filter(function(a){return!a.filtered});this._currentCenter=a.center;var d,e=this._map.latLngToLayerPoint(a.center);c.length>=this._spiralCountTrigger?d=this._generatePointsSpiral(c.length,e):(this._multiLines&&(e.y+=10),d=this._generatePointsCircle(c.length,e));for(var f=[],g=[],h=[],i=0,j=d.length;j>i;++i){var k=this._map.layerPointToLatLng(d[i]),l=this._cluster.BuildLeafletMarker(c[i],a.center);l.setZIndexOffset(5e3),l.setOpacity(0),this._currentMarkers.push(l),this._map.addLayer(l),g.push(l),h.push(k)}window.setTimeout(function(){for(i=0,j=d.length;j>i;++i)g[i].setLatLng(h[i]).setOpacity(1);var c=+new Date,e=42,k=290,l=window.setInterval(function(){f=[];var e=+new Date,g=e-c;if(g>=k)window.clearInterval(l),m=1;else var m=g/k;var n=a.center;for(i=0,j=d.length;j>i;++i){var o=h[i],p=o.lat-n.lat,q=o.lng-n.lng;f.push([n,new L.LatLng(n.lat+p*m,n.lng+q*m)])}b._lines.setLatLngs(f)},e)},1),this._lines.setLatLngs(f),this._map.addLayer(this._lines),this._clusterMarker=a.marker.setOpacity(.3)}},_generatePointsCircle:function(a,b){var c,d,e=this.spiderfyDistanceMultiplier*this._circleFootSeparation*(2+a),f=e/this._2PI,g=this._2PI/a,h=[];for(h.length=a,c=a-1;c>=0;c--)d=this._circleStartAngle+c*g,h[c]=new L.Point(Math.round(b.x+f*Math.cos(d)),Math.round(b.y+f*Math.sin(d)));return h},_generatePointsSpiral:function(a,b){var c,d=this.spiderfyDistanceMultiplier*this._spiralLengthStart,e=this.spiderfyDistanceMultiplier*this._spiralFootSeparation,f=this.spiderfyDistanceMultiplier*this._spiralLengthFactor,g=0,h=[];for(h.length=a,c=a-1;c>=0;c--)g+=e/d+5e-4*c,h[c]=new L.Point(Math.round(b.x+d*Math.cos(g)),Math.round(b.y+d*Math.sin(g))),d+=this._2PI*f/g;return h},Unspiderfy:function(){for(var a=this,b=0,c=this._currentMarkers.length;c>b;++b)this._currentMarkers[b].setLatLng(this._currentCenter).setOpacity(0);var d=this._currentMarkers;window.setTimeout(function(){for(b=0,c=d.length;c>b;++b)a._map.removeLayer(d[b])},300),this._currentMarkers=[],this._map.removeLayer(this._lines),this._clusterMarker&&this._clusterMarker.setOpacity(1)},onRemove:function(a){this.Unspiderfy(),a.off("overlappingmarkers",this.Spiderfy,this),a.off("click",this.Unspiderfy,this),a.off("zoomend",this.Unspiderfy,this)}});
//# sourceMappingURL=PruneCluster.min.js.map